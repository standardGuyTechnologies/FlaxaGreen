<template>
  <div class="page" data-name="home">
    <!-- Top Navbar -->
    <div class="navbar">
      <div class="navbar-bg"></div>
      <div class="navbar-inner">
        <div class="left">
          <a href="#" class="link icon-only panel-open" data-panel="left">
            <i class="icon f7-icons if-not-md">menu</i>
            <i class="icon material-icons if-md">menu</i>
          </a>
        </div>
        <div class="title sliding">Flaxa Green</div>
        <div class="right">
          <a href="#" class="link icon-only panel-open" data-panel="right">
            <i class="icon f7-icons if-not-md">menu</i>
            <i class="icon material-icons if-md">menu</i>
          </a>
        </div>
      </div>
    </div>
    <!-- Scrollable page content-->
    <div class="page-content">
      <div class="list list-strong list-outline list-dividers-ios no-chevron">
        <ul>
          <li class="list-group-title">Quick Actions</li>
          <li>
            <a href="/general-info/" class="item-content item-link">
              <div class="item-media"><i class="icon f7-icons">info_circle</i></div>
              <div class="item-inner">
                <div class="item-title">General Information</div>
              </div>
            </a>
          </li>
          <li>
            <a href="#" class="item-content item-link" @click=${chooseAcc}>
              <div class="item-media"><i class="icon f7-icons">doc_text_viewfinder</i></div>
              <div class="item-inner">
                <div class="item-title">Active Account
                </div>
                <div class="item-after">${active}</div>
              </div>
            </a>
          </li>
          <li>
            <a href="#" class="item-content item-link" @click=${popAccDialog}>
              <div class="item-media"><i class="icon f7-icons">wallet</i></div>
              <div class="item-inner">
                <div class="item-title">Add Account</div>
              </div>
            </a>
          </li>
          <li>
            <a href="#" class="item-content item-link" @click=${showCalendar}>
              <div class="item-media"><i class="icon f7-icons">calendar_badge_plus</i></div>
              <div class="item-inner">
                <div class="item-title">Add Date Entry</div>
              </div>
            </a>
          </li>
        </ul>
      </div>
      <div class="list list-outline-ios list-strong-ios list-dividers-ios">
        <ul>
          <li class="list-group-title">Timeline</li>
          ${tldata.map(entry => $h`
            <li>
              <a href="/transact/${entry.date}/${entry.acc}/" class="item-link item-content no-chevron">
                <div class="item-inner">
                  <div class="item-title">
                    <div class="item-header">${entry.acc} - ${datestr(entry.datestr)}</div>
                    <div class="inout">
                      NET CASH FLOW: ${entry.net}
                    </div>
                  </div>
                  <div class="item-after"><i class="f7-icons if-not-md">trash_fill</i></div>
                </div>
              </a>
            </li>
          `)}
        </ul>
      </div>
    </div>
  </div>
</template>

<style>
  .item-media {
    color: var(--f7-list-item-after-text-color)
  }
  .size-20 { font-size: 20px }
  .size-25 { font-size: 25px }
  .size-30 { font-size: 30px }
  .size-50 { font-size: 50px }

  .inout {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1px;
    padding-bottom: 1px;
    width: auto;
    max-width: 100%;
  }

  .flow {
    padding-left: 4px;
    padding-right: 8px;
  }
</style>

<script>
  import validate from '../js/oopform.js';
  import getDB from '../js/db.js';
  import G from '../js/uiglobals.js';
  const { maxamt, box, appmsgs } = G.V;
  const {getFirstTime, aboveThreshold, preload_image, } = G.F;

  export default (props, { $f7ready, $f7, $, $on, $onMounted, $onBeforeUnmount, $onUnmounted, $update }) => {
    const TOPG = {};  // todo unmount everything on this obj when page unmount.
    const page = $('.page[data-name="home"]')[0];
    let tldata = props.arr;

    function datestr(str) {
      return new Date(str).toDateString();
    }

    let active = '', counts = 0;
    $on('pageInit', () => {
      accListUpdate();
      TOPG.dialog = $f7.dialog.create({
        // containerEl: ".page-master",
        // backdrop: false,
        title: 'Add Account',
        text: '',
        content: dialoginputs,
        buttons: [
          { text: 'Cancel', close: true, },
          {
            text: 'Save', keyCodes: [13], 
            close: false,
            onClick: function(dialog, e){
              $('form#create').submit();
            }
          },
        ],
      });
      TOPG.calendarModal = $f7.calendar.create({
        disabled: {
          from: new Date()
        },
        dateFormat: { weekday: 'long', month: 'long', day: '2-digit', year: 'numeric' },
        openIn: 'customModal',
        header: true,
        footer: true,
        backdrop: true,
        closeByBackDropClick: false,
        on: {
          closed: function (calendar) {
            let acc = active; let calArr = calendar.getValue();
            if (!calArr) return $f7.dialog.alert('Please pick a date', 'Alert!')
            let date = calArr[0];
            let test1 = tldata.filter(o => o.date === date)
            let test2 = test1.filter(o => o.acc === acc);
            if (test2.length) return $f7.dialog.alert('Date entry on this account already exist', "Oops!")
            let datestr = date.toISOString();
            let net = 0, qdiff = 0, tdiff = 0;
            tldata.push({date, datestr, acc, net, qdiff, tdiff}); 
            $update(() => $f7.dialog.alert('Date entry added', 'Done!'));
          }
        }
      });
      validate($('form#create')[0], notify, notifyoff);
      $('form#create').on('submit', function() {
        if (counts === 2) return $f7.dialog.alert('Account Limit', 'Failed!');
        const inputs = $("#create input");
        const acc = inputs.eq(0).val().trim();
        const bal = Math.round(Number(inputs.eq(1).val()) * 100)/100; /* round 2dp */
        getDB().transaction(function (tx) {
          tx.executeSql('INSERT INTO ACCOUNTS (acc, bal) VALUES (?, ?)', [acc, bal])
          TOPG.dialog.close(); $f7.dialog.alert('Account created.', 'Success!');
          accListUpdate();
        })
      });
    })

    $onBeforeUnmount(() => {
      $f7.calendar.destroy('#demo-calendar-modal');
    })
    $on('pageBeforeRemove', () => {
      TOPG.actionSheet.destroy();
    })
    $onUnmounted(() => {
      Object.keys(TOPG).forEach(key => delete TOPG[key]);
    })

    /* 
    todo timeline db schema
    [id:pri-key(use utcdatenum), y, m, d, acc, out, in, at, search(combine: acc+out+in+at)]

    */

    function accListUpdate() {
      const db = getDB();
      db.transaction(function (tx) {
        tx.executeSql('SELECT acc FROM ACCOUNTS', [], function (tx, result) {
          const res = result.rows, accounts = [];
          for (let i = 0; i < res.length; i++) {
            accounts.push({ text: res.item(i).acc, onClick: setActive });
          }
          TOPG.actionSheet && TOPG.actionSheet.destroy();
          TOPG.actionSheet = $f7.actions.create({
            // containerEl: ".page-master",
            buttons: [
              // First Group
              accounts,
              // Second Group
              [
                { text: 'Cancel', color: 'red' }
              ]
            ],
          });
          active = accounts[0].text; counts = accounts.length; $update();
        })
      }, function (e) { $f7.dialog.alert(e) }, function () { });
    }
    function setActive (actions, e) {
      active = e.target.textContent; $update();
    }
    function showCalendar () {
      TOPG.calendarModal.open();
    }

    function chooseAcc () {
      console.log('choosing...')
      TOPG.actionSheet.open();
    }

    let dialoginputs = `
    <form id="create" class="list list-dividers-ios">
      <ul>
        <li class="item-content item-input">
          <div class="item-inner">
            <div class="item-title item-label">Title</div>
            <div class="item-input-wrap">
              <input name="dialog-accname" type="text" placeholder="Account name" pattern='[\-A-Za-z0-9]+' data-pattern="Account name accepts only alpha-numeric characters and hyhens!" maxlength=20 required validate />
              <span class="input-clear-button"></span>
            </div>
          </div>
        </li>
        <li class="item-content item-input">
          <div class="item-inner">
            <div class="item-title item-label">Set Price</div>
            <div class="item-input-wrap">
              <input type="number" name="dialog-accbal" placeholder="Cash balance" data-range="The cash balance provided exceeds limits!" max=${maxamt} min=0 data-step="Invalid lower denominations" step=0.01 required validate />
              <span class="input-clear-button"></span>
            </div>
          </div>
        </li>
      </ul>
    </form>`;

    function popAccDialog(){
      TOPG.dialog.open();
    }  
    function notify(inp, msg = '') {
      $(inp).data("error-message", msg);
      $f7.input.validate(inp);
    }
    function notifyoff(inp, msg=''){
      $f7.input.validate(inp);
    }


    return $render;
  }
</script>