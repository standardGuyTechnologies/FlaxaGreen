<template>
  <div class="page" data-name="fast-tr">
    <div class="navbar">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">Fast Transactions</div>
      </div>
    </div>
    <div class="toolbar toolbar-bottom no-hairline">
      <div class="toolbar-inner flex-c--">
        <a href="#" class="link" @click=${save}>Add Transaction</a>
      </div>
    </div>
    <div class="page-content">
      <!-- <div></div> -->
      <${Categories} code="x" categ=${categ} subcateg=${subcateg} type="fast" />
      <${Details} categ=${categ} subcateg=${subcateg} type="fast" />
      
    </div>
  </div>  
</template>

<style>
  .page[data-name="fast-tr"] {
  --f7-toolbar-height: 44px;
  --f7-toolbar-font-size: 17px;
  --f7-toolbar-inner-padding-left: 8px;
  --f7-toolbar-inner-padding-right: 8px;
  --f7-toolbar-link-font-weight: 400;
  /*
  --f7-toolbar-link-height: var(--f7-toolbar-height);
  --f7-toolbar-link-line-height: var(--f7-toolbar-height);
  --f7-tabbar-link-active-color: var(--f7-theme-color);
  */
  --f7-tabbar-icons-height: 50px;
  --f7-tabbar-icons-tablet-height: 50px;
  --f7-tabbar-icon-size: 28px;
  --f7-tabbar-link-text-transform: none;
  --f7-tabbar-link-font-weight: 400;
  --f7-tabbar-link-letter-spacing: 0;
  --f7-tabbar-label-font-size: 12px;
  --f7-tabbar-label-tablet-font-size: 14px;
  --f7-tabbar-label-font-weight: 500;
  --f7-tabbar-label-letter-spacing: 0.01;
  --f7-tabbar-link-inactive-color: rgba(0, 0, 0, 0.4);
}
/* 
.page[data-name="fast-tr"] {
    --f7-toolbar-height: 44px;
    --f7-toolbar-font-size: 17px;
    --f7-toolbar-inner-padding-left: 8px;
    --f7-toolbar-inner-padding-right: 8px;
    --f7-toolbar-link-font-weight: 400;
    --f7-tabbar-icons-height: 100px;
    --f7-tabbar-icons-tablet-height: 120px;
    --f7-tabbar-icon-size: 60px;
    --f7-tabbar-link-text-transform: none;
    --f7-tabbar-link-font-weight: 400;
    --f7-tabbar-link-letter-spacing: 0;
    --f7-tabbar-label-font-size: 18px;
    --f7-tabbar-label-tablet-font-size: 20px;
    --f7-tabbar-label-font-weight: 500;
    --f7-tabbar-label-letter-spacing: 0.01;
    --f7-tabbar-link-inactive-color: rgba(0, 0, 0, 0.4);
} */
  .page[data-name="fast-tr"] .list-group-title{
    display: flex;
    justify-content: space-between;
    font-weight: bold;
  }
  .page[data-name="fast-tr"] .item-after .card {
    margin: 0;
  }
  .page[data-name="fast-tr"] .item-after .card-header {
    min-height: 0px;
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    padding: 0;
  }
  .page[data-name="fast-tr"] .item-after .card-content {
    display: flex;
    justify-content: flex-end;
    line-height: 1.2px;
  }
  form#main-categ {
    margin: 0;
    max-height: 70vh; overflow-y: auto;
  }
  .popover .list {
    max-height: 180px; 
    overflow-y: scroll;
  }
</style>

<script>
  import validate from '../js/oopform.js';
  import getDB from '../js/db.js';
  import G from '../js/uiglobals.js';
  const { maxamt, box, appmsgs, labelmap } = G.V;
  const {getFirstTime, aboveThreshold, preload_image, } = G.F;

  import Categories from '../pages/local-components/categ.js';
  import {Details} from '../pages/local-components/categ.js';
  export default (props, { $f7ready, $f7, $on, $onMounted, $onBeforeUnmount, $store, $update }) => {

    const TOPG = {};
    const categ = "Expenses", subcateg="Fast food";


    $on('pageInit', () => {

      // todo create a factual prevlocation db/store
      const prevlocation = ["Yaba", "Ikeja", "Victoria Island", "Ikeja"];
      TOPG.typeahead = $f7.autocomplete.create({
        inputEl: '#typeahead',
        openIn: 'dropdown',
        typeahead: true,
        source: function (query, render) {
          var results = [];
          if (query.length === 0) {
            render(results);
            return;
          }
          // Find matched items
          for (var i = 0; i < prevlocation.length; i++) {
            if (prevlocation[i].toLowerCase().indexOf(query.toLowerCase()) === 0) results.push(prevlocation[i]);
          }
          // Render items by passing array with result items
          render(results);
        }
      });

    })

    $onBeforeUnmount(() => {
      TOPG.typeahead.destroy();
    })
    

    function save () {
      const dform = $('form#details')[0];
      const categ = dform.categ.value; 
      const subcateg = dform.subcateg.value;
      const item = dform.item.value;
      const amt = Number(dform.amt.value) * labelmap.get(categ).sign
      const qty = dform.qty.value;
      const location = dform.location.value;
      const info = dform.info.value;

      getDB().transaction(function (tx) {
        // make a version for transfer, replacing qty with target todo
        // rule no1 anytime u update quick you must update quickdiff
        tx.executeSql('INSERT INTO QUICK (date, acc, categ, subcateg, item, amt, qty, location, info) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)', [props.date, props.acc, categ, subcateg, item, amt, qty, location, info], function (tx, result) {
        tx.executeSql('DELETE FROM QUICKDIFF', [], function (tx, result) {
          tx.executeSql('INSERT INTO QUICKDIFF SELECT date, acc, SUM(amt) AS qdiff FROM QUICK GROUP BY date, acc', [], function (tx, result) {
            $f7.dialog.alert('Transaction saved', 'Done!')
          });
        });
      })
      }, function (e) {console.log(e)}, function () {$f7.emit(categ+subcateg)});
    }

    return $render;
  }
</script>